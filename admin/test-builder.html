<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Construtor de Testes | Anova Saúde</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚙️</text></svg>">
  <link rel="stylesheet" href="/css/style.css">
  <style>
    * { box-sizing: border-box; }
    body { background: #faf8f5; margin: 0; padding: 1rem; font-family: 'Work Sans', sans-serif; }
    
    .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); overflow: hidden; }
    
    .header { background: #1a4d2e; color: white; padding: 2rem; }
    .header h1 { margin: 0 0 0.5rem; font-size: 1.75rem; font-weight: 600; }
    .header p { margin: 0; opacity: 0.9; font-size: 1rem; }
    
    .toolbar { padding: 1.25rem; border-bottom: 1px solid #e0e0e0; background: #f8f9fa; }
    .toolbar-row { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }
    .toolbar-row:not(:last-child) { margin-bottom: 0.75rem; }
    .toolbar-row.center { justify-content: center; }
    .toolbar-separator { color: #6c757d; font-weight: 300; font-size: 1.2rem; margin: 0 0.5rem; }
    .toolbar-label { color: #5a5a5a; font-size: 0.9rem; font-weight: 500; margin-right: 0.5rem; }
    .status { margin-left: auto; color: #5a5a5a; font-size: 0.9rem; font-weight: 500; }
    
    .btn { padding: 0.6rem 1.1rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.2s; min-width: 110px; }
    .btn-primary { background: #1a4d2e; color: white; }
    .btn-primary:hover { background: #2d6a4f; transform: translateY(-1px); }
    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #218838; transform: translateY(-1px); }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #5a6268; }
    .btn-danger { background: #dc3545; color: white; font-size: 0.85rem; }
    .btn-danger:hover { background: #c82333; }
    .btn-small { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
    
    .content { padding: 2rem; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2.5rem; }
    
    .field { margin-bottom: 1.25rem; }
    .field label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: #2b2b2b; font-size: 0.95rem; }
    .field input, .field textarea, .field select { width: 100%; padding: 0.75rem; border: 1px solid #d0d0d0; border-radius: 6px; font-size: 0.95rem; font-family: inherit; transition: border-color 0.2s; background: white; }
    .field input:focus, .field textarea:focus, .field select:focus { outline: none; border-color: #1a4d2e; }
    .field textarea { min-height: 110px; resize: vertical; }
    .field small { display: block; margin-top: 0.3rem; color: #6c757d; font-size: 0.85rem; }
    
    .checkbox-group { display: flex; gap: 1rem; margin-top: 0.5rem; }
    .checkbox-label { display: inline-flex; align-items: center; gap: 0.6rem; padding: 0.6rem 1rem; border: 2px solid #e0e0e0; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s; background: white; }
    .checkbox-label:hover { border-color: #1a4d2e; background: #f8f9fa; }
    .checkbox-label input:checked { accent-color: #1a4d2e; }
    
    .section { margin-bottom: 3rem; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 2px solid #d0d0d0; }
    .section-header h3 { margin: 0; color: #2b2b2b; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem; font-weight: 600; }
    .section-header-left { display: flex; align-items: center; gap: 1rem; }
    .badge { display: inline-flex; align-items: center; justify-content: center; min-width: 28px; height: 28px; padding: 0 0.6rem; background: #6c757d; color: white; border-radius: 6px; font-size: 0.85rem; font-weight: 600; }
    .btn-collapse { background: transparent; border: none; color: #6c757d; font-size: 1.2rem; cursor: pointer; padding: 0.25rem 0.5rem; transition: color 0.2s; }
    .btn-collapse:hover { color: #2b2b2b; }
    .section-content { transition: max-height 0.3s ease, opacity 0.3s ease; overflow: hidden; }
    .section-content.collapsed { max-height: 0 !important; opacity: 0; }
    
    .card { background: #fafafa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.25rem; transition: box-shadow 0.2s; }
    .card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; }
    .card-title { font-size: 1.05rem; font-weight: 600; color: #1a4d2e; margin: 0; }
    .card-actions { display: flex; gap: 0.5rem; }
    
    .option-row { display: grid; grid-template-columns: 110px 1fr auto; gap: 0.75rem; margin-bottom: 0.75rem; align-items: center; }
    
    .question-selector { margin: 1rem 0; padding: 1.25rem; background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; }
    .question-selector-title { font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem; color: #5a5a5a; }
    .question-chips { display: flex; flex-wrap: wrap; gap: 0.6rem; }
    .chip { padding: 0.5rem 1rem; background: white; border: 1px solid #e0e0e0; border-radius: 6px; cursor: pointer; font-size: 0.88rem; font-weight: 500; transition: all 0.2s; user-select: none; }
    .chip:hover { border-color: #1a4d2e; transform: translateY(-1px); }
    .chip.selected { background: #1a4d2e; color: white; border-color: #1a4d2e; }
    
    .preview-section { margin-top: 2rem; }
    .preview { background: #1e1e1e; color: #d4d4d4; padding: 1.5rem; border-radius: 10px; overflow: auto; max-height: 550px; }
    .preview pre { margin: 0; font-family: 'Courier New', monospace; font-size: 0.88rem; line-height: 1.5; white-space: pre-wrap; }
    
    .empty-state { text-align: center; padding: 2rem; color: #6c757d; background: #f8f9fa; border-radius: 8px; }
    .empty-state-icon { font-size: 2.5rem; margin-bottom: 0.75rem; opacity: 0.4; }
    
    input[type="file"] { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="toolbar">
      <div class="toolbar-row center">
        <button class="btn btn-success" id="btn-save-server">☁️ Salvar no Servidor</button>
      </div>
      <div class="toolbar-row">
        <button class="btn btn-secondary" id="btn-sample" title="Preencher exemplo rápido">Exemplo</button>
        <span class="toolbar-separator">|</span>
        <span class="toolbar-label">Preview:</span>
        <select id="preview-scenario" style="padding: 0.6rem 0.8rem; border-radius: 6px; border: 1px solid #d0d0d0; font-size: 0.9rem; font-weight: 500; background: white;">
          <option value="random">Respostas Aleatórias</option>
          <option value="min">Pontuação Mínima</option>
          <option value="max">Pontuação Máxima</option>
          <option value="mid">Pontuação Média</option>
        </select>
        <button class="btn btn-secondary" id="btn-preview-results">Ver</button>
        <button class="btn btn-secondary" id="btn-clear" title="Limpar tudo">Limpar</button>
      </div>
    </div>

    <div style="background: #e7f3ff; border-left: 4px solid #0066cc; padding: 1rem; margin: 1rem 0; border-radius: 6px;">
      <strong>ℹ️ Este sistema apenas cria Questionários.</strong>
    </div>

    <div class="content">
      <!-- BASIC INFO -->
      <div class="grid">
        <div>
          <div class="field">
            <label for="test-title">Título <span style="color:#dc3545">*</span></label>
            <input id="test-title" placeholder="Escala de Ansiedade Generalizada">
          </div>
          <div class="field">
            <label for="test-id">ID do Teste <small style="color:#6c757d;font-weight:normal;">(gerado automaticamente)</small></label>
            <input id="test-id" readonly style="background:#f8f9fa;cursor:not-allowed;">
          </div>
          <div class="field">
            <label for="test-tag">Categoria / Tag</label>
            <input id="test-tag" placeholder="Ansiedade, Depressão, Personalidade">
          </div>
          <div class="field">
            <label for="article-url">Link do Artigo Científico</label>
            <input id="article-url" type="url" placeholder="https://pubmed.ncbi.nlm.nih.gov/...">
          </div>
          <div class="field">
            <label for="video-url">Link do Vídeo (Wistia)</label>
            <input id="video-url" type="url" placeholder="https://luisfca.wistia.com/medias/r9ja6ay4hi">
          </div>
          <div class="field">
            <label for="test-category">Categoria do Teste</label>
            <select id="test-category">
              <option value="para-voce">Para você</option>
              <option value="para-seu-filho">Para seu filho</option>
            </select>
          </div>
        </div>
        <div>
          <div class="field">
            <label for="test-desc">Descrição <span style="color:#dc3545">*</span></label>
            <textarea id="test-desc" placeholder="Descrição breve que aparece no catálogo de testes"></textarea>
          </div>
          <div class="field">
            <label for="test-instr">Instruções para o Usuário <span style="color:#dc3545">*</span></label>
            <textarea id="test-instr" placeholder="Instruções que aparecem antes do usuário começar o teste"></textarea>
          </div>
          <div class="field">
            <label for="est-time">Tempo Estimado</label>
            <input id="est-time" placeholder="3-5 min, 10-15 min">
          </div>
          <div class="field">
            <label>Configurações</label>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="featured">
                <span>Destaque na homepage</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="curadoria">
                <span>Curadoria Anova</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="field">
        <label for="test-visibility">Visibilidade</label>
        <select id="test-visibility">
          <option value="public">Público (mostrar no catálogo)</option>
          <option value="hidden">Oculto (não mostrar no catálogo)</option>
        </select>
      </div>

      <!-- QUESTIONS -->
      <div class="section">
        <div class="section-header">
          <div class="section-header-left">
            <button class="btn-collapse" id="btn-collapse-questions" title="Ocultar/Mostrar">▼</button>
            <h3>Questões <span class="badge" id="q-count">0</span></h3>
          </div>
          <button class="btn btn-primary" id="btn-add-question">+ Adicionar Questão</button>
        </div>
        <div id="questions-list" class="section-content">
          <div class="empty-state">
            <div class="empty-state-icon">📝</div>
            <p>Nenhuma questão adicionada.</p>
          </div>
        </div>
      </div>

      <!-- FACTORS -->
      <div class="section">
        <div class="section-header">
          <div class="section-header-left">
            <button class="btn-collapse" id="btn-collapse-factors" title="Ocultar/Mostrar">▼</button>
            <h3>Fatores / Domínios <span class="badge" id="f-count">0</span></h3>
          </div>
          <button class="btn btn-primary" id="btn-add-factor">+ Adicionar Fator</button>
        </div>
        <div id="factors-list" class="section-content">
          <div class="empty-state">
            <div class="empty-state-icon">📊</div>
            <p>Nenhum fator definido.</p>
          </div>
        </div>
      </div>

      <!-- PREVIEW -->
      <div id="preview-section" class="preview-section" style="display:none;">
        <div class="section-header">
          <h3>📄 Pré-visualização JSON</h3>
          <div class="card-actions" style="gap:0.5rem;">
            <button class="btn btn-secondary btn-small" id="btn-copy">📋 Copiar JSON</button>
            <button class="btn btn-secondary" id="btn-close-preview">✕ Fechar</button>
          </div>
        </div>
        <div class="preview">
          <pre id="preview-content"></pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== STATE ==========
    const state = { questions: [], factors: [] };
    let questionIdCounter = 1;
    let existingTestIds = [];

    // ========== EDIT MODE DETECTION ==========
    const urlParams = new URLSearchParams(window.location.search);
    const editMode = urlParams.get('mode') === 'edit';
    const editTestId = urlParams.get('id');

    // ========== UI ELEMENTS ==========
    const qList = document.getElementById('questions-list');
    const fList = document.getElementById('factors-list');
    const qCount = document.getElementById('q-count');
    const fCount = document.getElementById('f-count');
    const previewSection = document.getElementById('preview-section');
    const previewContent = document.getElementById('preview-content');
    
    // Collapse toggle functionality
    document.getElementById('btn-collapse-questions').addEventListener('click', function() {
      const content = document.getElementById('questions-list');
      content.classList.toggle('collapsed');
      this.textContent = content.classList.contains('collapsed') ? '▶' : '▼';
    });
    
    document.getElementById('btn-collapse-factors').addEventListener('click', function() {
      const content = document.getElementById('factors-list');
      content.classList.toggle('collapsed');
      this.textContent = content.classList.contains('collapsed') ? '▶' : '▼';
    });

    // ========== HELPERS ==========
    function updateCounts() {
      qCount.textContent = state.questions.length;
      fCount.textContent = state.factors.length;
      
      // Remove empty states
      if (state.questions.length > 0) {
        const emptyState = qList.querySelector('.empty-state');
        if (emptyState) emptyState.remove();
      }
      if (state.factors.length > 0) {
        const emptyState = fList.querySelector('.empty-state');
        if (emptyState) emptyState.remove();
      }
    }

    function slugify(str) {
      return (str || '').toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '');
    }
    
    // Auto-generate unique ID from title
    function generateUniqueId(title) {
      let baseId = slugify(title);
      if (!baseId) return '';
      
      // If in edit mode, allow keeping the same ID
      if (editMode && baseId === editTestId) {
        return baseId;
      }
      
      let uniqueId = baseId;
      let counter = 2;
      
      // Check for duplicates and add counter if needed
      while (existingTestIds.includes(uniqueId)) {
        uniqueId = `${baseId}-${counter}`;
        counter++;
      }
      
      return uniqueId;
    }
    
    // Fetch existing test IDs
    async function loadExistingTestIds() {
      try {
        const response = await fetch('/api/tests');
        const data = await response.json();
        if (data.success && data.tests) {
          existingTestIds = data.tests.map(t => t.id);
        }
      } catch (error) {
        console.error('Failed to load existing test IDs:', error);
      }
    }

    function collectData() {
      const get = id => document.getElementById(id)?.value.trim() || '';
      
      return {
        id: get('test-id'),
        title: get('test-title'),
        description: get('test-desc'),
        tag: get('test-tag'),
        category: get('test-category') || 'para-voce',
        articleUrl: get('article-url') || undefined,
        videoUrl: get('video-url') || undefined,
        featured: document.getElementById('featured')?.checked || false,
        curadoria: document.getElementById('curadoria')?.checked || false,
        testType: 'questionnaire',
        visibility: get('test-visibility') || 'public',
        isPremium: false,
        instructions: get('test-instr'),
        estimatedTime: get('est-time') || undefined,
        questionCount: state.questions.length,
        questions: state.questions.map(q => ({
          id: q.id,
          title: q.titleInput.value.trim(),
          type: q.typeSelect.value,
          options: (q.options || []).map(opt => ({
            value: Number(opt.valueInput.value),
            text: opt.textInput.value.trim()
          })),
          min: q.minInput?.value ? Number(q.minInput.value) : undefined,
          max: q.maxInput?.value ? Number(q.maxInput.value) : undefined,
          step: q.stepInput?.value ? Number(q.stepInput.value) : undefined
        })),
        scoring: {
          min: 0,
          max: state.questions.reduce((sum, q) => {
            const qMax = Math.max(...(q.options || []).map(o => Number(o.valueInput?.value || 0)), 0);
            return sum + qMax;
          }, 0),
          factors: state.factors.map(f => ({
            id: f.idInput.value.trim() || slugify(f.nameInput.value),
            name: f.nameInput.value.trim(),
            questionIds: f.selectedQuestions || [],
            ranges: f.ranges.map(r => ({
              min: Number(r.minInput.value),
              max: Number(r.maxInput.value),
              level: r.levelInput.value.trim(),
              description: r.descInput.value.trim()
            }))
          }))
        }
      };
    }

    // ========== QUESTIONS ==========
    function addQuestion(data = null) {
      const qId = data?.id || questionIdCounter++;
      
      const card = document.createElement('div');
      card.className = 'card';

      // Header
      const header = document.createElement('div');
      header.className = 'card-header';
      
      const title = document.createElement('div');
      title.className = 'card-title';
      title.textContent = `Questão ${qId}`;
      
      const actions = document.createElement('div');
      actions.className = 'card-actions';
      
      header.appendChild(title);
      header.appendChild(actions);

      // Title input
      const titleField = document.createElement('div');
      titleField.className = 'field';
      titleField.innerHTML = '<label>Título da Questão</label>';
      const titleInput = document.createElement('input');
      titleInput.placeholder = 'Ex: Como você tem se sentido nas últimas 2 semanas?';
      titleInput.value = data?.title || '';
      titleField.appendChild(titleInput);

      // Type select
      const typeField = document.createElement('div');
      typeField.className = 'field';
      typeField.innerHTML = '<label>Tipo de Resposta</label>';
      const typeSelect = document.createElement('select');
      const types = [
        { value: 'single', label: 'Escolha Única' },
        { value: 'likert', label: 'Likert (1-5)' },
        { value: 'yesno', label: 'Sim/Não' },
        { value: 'scale', label: 'Escala Numérica' }
      ];
      types.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.value;
        opt.textContent = t.label;
        typeSelect.appendChild(opt);
      });
      typeSelect.value = data?.type || 'single';
      typeField.appendChild(typeSelect);

      // Options container
      const optionsContainer = document.createElement('div');
      optionsContainer.style.marginTop = '1rem';

      // Scale inputs
      const scaleContainer = document.createElement('div');
      scaleContainer.style.display = 'none';
      scaleContainer.innerHTML = `
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:1rem; margin-top:0.75rem;">
          <div class="field">
            <label>Valor Mínimo</label>
            <input type="number" class="scale-min" value="${data?.min || 0}">
          </div>
          <div class="field">
            <label>Valor Máximo</label>
            <input type="number" class="scale-max" value="${data?.max || 10}">
          </div>
          <div class="field">
            <label>Incremento</label>
            <input type="number" class="scale-step" value="${data?.step || 1}">
          </div>
        </div>
      `;
      const minInput = scaleContainer.querySelector('.scale-min');
      const maxInput = scaleContainer.querySelector('.scale-max');
      const stepInput = scaleContainer.querySelector('.scale-step');

      // Button to add options
      const btnAddOption = document.createElement('button');
      btnAddOption.className = 'btn btn-secondary btn-small';
      btnAddOption.textContent = '+ Adicionar Opção';
      btnAddOption.style.marginTop = '0.75rem';

      // Create entry object
      const entry = {
        id: qId,
        titleInput,
        typeSelect,
        options: [],
        optionsContainer,
        minInput,
        maxInput,
        stepInput,
        card
      };

      state.questions.push(entry);

      // Type change handler
      typeSelect.addEventListener('change', () => {
        const type = typeSelect.value;
        const needsOptions = ['single', 'likert', 'yesno'].includes(type);
        
        optionsContainer.style.display = needsOptions ? 'block' : 'none';
        btnAddOption.style.display = needsOptions ? 'block' : 'none';
        scaleContainer.style.display = type === 'scale' ? 'block' : 'none';

        // Auto-populate Likert
        if (type === 'likert' && entry.options.length === 0) {
          for (let i = 1; i <= 5; i++) {
            addOption(entry, i, '');
          }
        }

        updateFactorSelectors();
      });

      btnAddOption.addEventListener('click', () => addOption(entry));

      // Duplicate button
      const btnDuplicate = document.createElement('button');
      btnDuplicate.className = 'btn btn-secondary btn-small';
      btnDuplicate.textContent = '📋';
      btnDuplicate.title = 'Duplicar questão';
      btnDuplicate.addEventListener('click', () => {
        addQuestion({
          title: titleInput.value,
          type: typeSelect.value,
          options: entry.options.map(o => ({ 
            value: o.valueInput.value, 
            text: o.textInput.value 
          })),
          min: minInput?.value,
          max: maxInput?.value,
          step: stepInput?.value
        });
      });

      // Remove button
      const btnRemove = document.createElement('button');
      btnRemove.className = 'btn btn-danger btn-small';
      btnRemove.textContent = '🗑️';
      btnRemove.title = 'Remover questão';
      btnRemove.addEventListener('click', () => {
        if (confirm('Remover esta questão?')) {
          state.questions = state.questions.filter(q => q !== entry);
          card.remove();
          updateCounts();
          updateFactorSelectors();
        }
      });

      actions.appendChild(btnDuplicate);
      actions.appendChild(btnRemove);

      // Assemble card
      card.appendChild(header);
      card.appendChild(titleField);
      card.appendChild(typeField);
      card.appendChild(optionsContainer);
      card.appendChild(scaleContainer);
      card.appendChild(btnAddOption);

      qList.appendChild(card);

      // Load existing options or defaults
      if (data?.options?.length) {
        data.options.forEach(o => addOption(entry, o.value, o.text));
      } else if (typeSelect.value === 'likert') {
        for (let i = 1; i <= 5; i++) {
          addOption(entry, i, '');
        }
      }

      // Set initial visibility
      const needsOptions = ['single', 'likert', 'yesno'].includes(typeSelect.value);
      optionsContainer.style.display = needsOptions ? 'block' : 'none';
      btnAddOption.style.display = needsOptions ? 'block' : 'none';
      scaleContainer.style.display = typeSelect.value === 'scale' ? 'block' : 'none';

      updateCounts();
      updateFactorSelectors();
    }

    function addOption(qEntry, defVal = 0, defText = '') {
      const row = document.createElement('div');
      row.className = 'option-row';

      const valueInput = document.createElement('input');
      valueInput.type = 'number';
      valueInput.value = defVal;
      valueInput.placeholder = 'Valor';
      valueInput.style.padding = '0.6rem';
      valueInput.style.border = '2px solid #e8e3db';
      valueInput.style.borderRadius = '6px';

      const textInput = document.createElement('input');
      textInput.value = defText;
      textInput.placeholder = 'Texto da opção de resposta';
      textInput.style.padding = '0.6rem';
      textInput.style.border = '2px solid #e8e3db';
      textInput.style.borderRadius = '6px';

      const btnRemove = document.createElement('button');
      btnRemove.className = 'btn btn-danger btn-small';
      btnRemove.textContent = '✕';
      btnRemove.addEventListener('click', () => {
        qEntry.options = qEntry.options.filter(o => o !== optEntry);
        row.remove();
      });

      const optEntry = { valueInput, textInput };
      qEntry.options.push(optEntry);

      row.appendChild(valueInput);
      row.appendChild(textInput);
      row.appendChild(btnRemove);
      qEntry.optionsContainer.appendChild(row);
    }

    // ========== FACTORS ==========
    function addFactor(data = null) {
      const card = document.createElement('div');
      card.className = 'card';

      // Header
      const header = document.createElement('div');
      header.className = 'card-header';
      header.innerHTML = '<div class="card-title">Fator / Domínio</div>';
      
      const btnRemove = document.createElement('button');
      btnRemove.className = 'btn btn-danger btn-small';
      btnRemove.textContent = '🗑️ Remover';
      btnRemove.addEventListener('click', () => {
        if (confirm('Remover este fator?')) {
          state.factors = state.factors.filter(f => f !== entry);
          card.remove();
          updateCounts();
        }
      });
      
      const actions = document.createElement('div');
      actions.className = 'card-actions';
      actions.appendChild(btnRemove);
      header.appendChild(actions);

      // Name input
      const nameField = document.createElement('div');
      nameField.className = 'field';
      nameField.innerHTML = '<label>Nome do Fator</label>';
      const nameInput = document.createElement('input');
      nameInput.placeholder = 'Ex: Extroversão, Neuroticismo, Ansiedade Social';
      nameInput.value = data?.name || '';
      nameField.appendChild(nameInput);

      // ID input
      const idField = document.createElement('div');
      idField.className = 'field';
      idField.innerHTML = '<label>ID do Fator (opcional)</label>';
      const idInput = document.createElement('input');
      idInput.placeholder = 'Gerado automaticamente se deixar em branco';
      idInput.value = data?.id || '';
      idField.appendChild(idInput);

      // Question selector
      const questionSelector = document.createElement('div');
      questionSelector.className = 'question-selector';
      questionSelector.innerHTML = `
        <div class="question-selector-title">
          Selecione as questões que compõem este fator:
        </div>
        <div class="question-chips" data-chips></div>
      `;

      // Ranges container
      const rangesContainer = document.createElement('div');
      rangesContainer.style.marginTop = '1.5rem';
      
      const rangesTitle = document.createElement('div');
      rangesTitle.style.fontWeight = '600';
      rangesTitle.style.marginBottom = '0.75rem';
      rangesTitle.textContent = 'Faixas de Interpretação:';
      rangesContainer.appendChild(rangesTitle);

      // Button to add range
      const btnAddRange = document.createElement('button');
      btnAddRange.className = 'btn btn-secondary btn-small';
      btnAddRange.textContent = '+ Adicionar Faixa';
      btnAddRange.style.marginTop = '0.75rem';

      // Create entry
      const entry = {
        nameInput,
        idInput,
        ranges: [],
        rangesContainer,
        questionSelector,
        selectedQuestions: data?.questionIds || []
      };

      state.factors.push(entry);

      btnAddRange.addEventListener('click', () => addRange(entry));

      // Assemble card
      card.appendChild(header);
      card.appendChild(nameField);
      card.appendChild(idField);
      card.appendChild(questionSelector);
      card.appendChild(rangesContainer);
      card.appendChild(btnAddRange);

      fList.appendChild(card);

      // Load existing ranges or add default
      if (data?.ranges?.length) {
        data.ranges.forEach(r => addRange(entry, r));
      } else {
        addRange(entry);
      }

      updateCounts();
      updateFactorQuestionSelector(entry);
    }

    function updateFactorSelectors() {
      state.factors.forEach(f => updateFactorQuestionSelector(f));
    }

    function updateFactorQuestionSelector(factorEntry) {
      const chipsContainer = factorEntry.questionSelector.querySelector('[data-chips]');
      chipsContainer.innerHTML = '';

      if (state.questions.length === 0) {
        chipsContainer.innerHTML = '<small style="color:#6c757d;">Adicione questões primeiro para selecionar</small>';
        return;
      }

      state.questions.forEach(q => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        
        const title = q.titleInput.value.trim() || 'Sem título';
        const preview = title.length > 40 ? title.substring(0, 40) + '...' : title;
        chip.textContent = `Q${q.id}: ${preview}`;
        chip.title = title;

        if (factorEntry.selectedQuestions.includes(q.id)) {
          chip.classList.add('selected');
        }

        chip.addEventListener('click', () => {
          if (factorEntry.selectedQuestions.includes(q.id)) {
            factorEntry.selectedQuestions = factorEntry.selectedQuestions.filter(id => id !== q.id);
            chip.classList.remove('selected');
          } else {
            factorEntry.selectedQuestions.push(q.id);
            chip.classList.add('selected');
          }
        });

        chipsContainer.appendChild(chip);
      });
    }

    function addRange(factorEntry, data = null) {
      const rangeCard = document.createElement('div');
      rangeCard.style.background = 'white';
      rangeCard.style.border = '2px solid #e8e3db';
      rangeCard.style.borderRadius = '8px';
      rangeCard.style.padding = '1rem';
      rangeCard.style.marginBottom = '0.75rem';

      const grid = document.createElement('div');
      grid.style.display = 'grid';
      grid.style.gridTemplateColumns = '100px 100px 1fr auto';
      grid.style.gap = '0.75rem';
      grid.style.alignItems = 'end';

      const minField = document.createElement('div');
      minField.className = 'field';
      minField.style.marginBottom = '0';
      minField.innerHTML = `
        <label>Mínimo</label>
        <input type="number" value="${data?.min || 0}">
      `;

      const maxField = document.createElement('div');
      maxField.className = 'field';
      maxField.style.marginBottom = '0';
      maxField.innerHTML = `
        <label>Máximo</label>
        <input type="number" value="${data?.max || 10}">
      `;

      const levelField = document.createElement('div');
      levelField.className = 'field';
      levelField.style.marginBottom = '0';
      levelField.innerHTML = `
        <label>Nível</label>
        <input value="${data?.level || ''}" placeholder="Baixo, Moderado, Alto">
      `;

      const minInput = minField.querySelector('input');
      const maxInput = maxField.querySelector('input');
      const levelInput = levelField.querySelector('input');

      const btnRemove = document.createElement('button');
      btnRemove.className = 'btn btn-danger btn-small';
      btnRemove.textContent = '✕';
      btnRemove.addEventListener('click', () => {
        factorEntry.ranges = factorEntry.ranges.filter(r => r !== rangeEntry);
        rangeCard.remove();
      });

      const descField = document.createElement('div');
      descField.className = 'field';
      descField.style.marginTop = '0.75rem';
      descField.style.marginBottom = '0';
      descField.innerHTML = `
        <label>Descrição / Interpretação</label>
        <textarea>${data?.description || ''}</textarea>
      `;
      const descInput = descField.querySelector('textarea');

      const rangeEntry = { minInput, maxInput, levelInput, descInput };
      factorEntry.ranges.push(rangeEntry);

      grid.appendChild(minField);
      grid.appendChild(maxField);
      grid.appendChild(levelField);
      grid.appendChild(btnRemove);

      rangeCard.appendChild(grid);
      rangeCard.appendChild(descField);
      factorEntry.rangesContainer.appendChild(rangeCard);
    }

    // ========== ACTIONS ==========
    // Removed btn-new, btn-import, file-input event listeners

    function loadTest(data) {
      // Clear existing
      state.questions = [];
      state.factors = [];
      qList.innerHTML = '';
      fList.innerHTML = '';

      // Load basic info (temporarily enable ID field to set value)
      const idField = document.getElementById('test-id');
      idField.removeAttribute('readonly');
      idField.style.background = '';
      idField.style.cursor = '';
      
      idField.value = data.id || '';
      document.getElementById('test-title').value = data.title || '';
      document.getElementById('test-desc').value = data.description || '';
      document.getElementById('test-tag').value = data.tag || '';
      document.getElementById('test-category').value = data.category || 'para-voce';
      document.getElementById('article-url').value = data.articleUrl || '';
      document.getElementById('video-url').value = data.videoUrl || '';
      document.getElementById('featured').checked = data.featured || false;
      document.getElementById('curadoria').checked = data.curadoria || false;
      document.getElementById('test-visibility').value = data.visibility || 'public';
      document.getElementById('test-instr').value = data.instructions || '';
      document.getElementById('est-time').value = data.estimatedTime || '';
      
      // Restore readonly state after a brief delay
      setTimeout(() => {
        idField.setAttribute('readonly', 'readonly');
        idField.style.background = '#f8f9fa';
        idField.style.cursor = 'not-allowed';
      }, 100);

      // Reset counter
      questionIdCounter = 1;

      // Load questions
      (data.questions || []).forEach(q => {
        if (q.id >= questionIdCounter) questionIdCounter = q.id + 1;
        addQuestion(q);
      });

      // Load factors
      (data.scoring?.factors || []).forEach(f => addFactor(f));

      updateCounts();
    }

    // Load test from server (for edit mode)
    async function loadTestFromServer(testId) {
      try {
        const response = await fetch(`/api/tests/${testId}`);
        
        if (!response.ok) {
          throw new Error('Teste não encontrado');
        }
        
        const result = await response.json();
        
        if (!result.success || !result.test) {
          throw new Error('Erro ao carregar teste');
        }
        
        const testData = result.test;
        loadTest(testData);
        
        // Update save button text
        const saveBtn = document.getElementById('btn-save-server');
        if (saveBtn) saveBtn.textContent = '💾 Atualizar Teste';
      } catch (error) {
        alert(`Não foi possível carregar o teste: ${error.message}`);
      }
    }

    // Initialize edit mode on page load
    window.addEventListener('DOMContentLoaded', () => {
      if (editMode && editTestId) {
        loadTestFromServer(editTestId);
      }
    });

    // Removed btn-export event listener

    document.getElementById('btn-save-server').addEventListener('click', async () => {
      const data = collectData();
      
      if (!data.title) {
        alert('❌ Defina o título do teste antes de salvar');
        return;
      }
      
      if (!data.id) {
        alert('❌ Erro: ID do teste não foi gerado corretamente');
        return;
      }
      
      try {
        let response;
        
        if (editMode && editTestId) {
          // Edit mode: Use PUT directly
          response = await fetch(`/api/tests/${editTestId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
        } else {
          // Create mode: Try POST first, fallback to PUT if exists
          response = await fetch('/api/tests', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });

          // If test exists, try PUT (update)
          if (!response.ok) {
            const error = await response.json();
            if (error.error && error.error.includes('exists')) {
              response = await fetch(`/api/tests/${data.id}`, {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
              });
            }
          }
        }

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Erro ao salvar teste');
        }

        const result = await response.json();
        
        // Show success popup
        alert(editMode ? `✅ Teste "${data.title}" atualizado com sucesso!` : `✅ Teste "${data.title}" criado com sucesso!`);
        
        // Redirect to admin dashboard
        if (window.parent !== window) {
          // If in iframe, redirect parent window
          window.parent.postMessage({ type: 'testSaved', testId: data.id }, '*');
          window.parent.location.href = '/admin';
        } else {
          // If standalone, redirect this window
          window.location.href = '/admin';
        }
        
      } catch (error) {
        alert(`Erro ao salvar teste: ${error.message}`);
      }
    });

    // Removed btn-preview event listener

    const copyBtn = document.getElementById('btn-copy');
    copyBtn.addEventListener('click', async () => {
      const data = collectData();
      try {
        await navigator.clipboard.writeText(JSON.stringify(data, null, 2));
        const prevText = copyBtn.textContent;
        copyBtn.textContent = '✅ Copiado';
        setTimeout(() => { copyBtn.textContent = prevText; }, 1200);
      } catch (err) {
        copyBtn.textContent = '❌ Falha';
        setTimeout(() => { copyBtn.textContent = '📋 Copiar JSON'; }, 1200);
      }
    });

    document.getElementById('btn-close-preview').addEventListener('click', () => {
      previewSection.style.display = 'none';
    });

    // Auto-generate ID from title
    document.getElementById('test-title').addEventListener('input', (e) => {
      const title = e.target.value.trim();
      const idField = document.getElementById('test-id');
      
      if (!editMode || !idField.value) {
        idField.value = generateUniqueId(title);
      }
    });
    
    document.getElementById('btn-add-question').addEventListener('click', () => addQuestion());
    document.getElementById('btn-add-factor').addEventListener('click', () => addFactor());

    // Exemplo rápido
    const sampleData = {
      id: 'gad_123',
      title: 'titulo do teste -GAD',
      description: 'Descricao aqui',
      tag: 'Ansiedade',
      category: 'para-voce',
      videoUrl: 'https://luisfca.wistia.com/medias/r9ja6ay4hi',
      articleUrl: 'https://www.google.com.br',
      featured: false,
      curadoria: false,
      testType: 'questionnaire',
      visibility: 'public',
      isPremium: false,
      instructions: 'Instrucoes aqui',
      estimatedTime: '10 minutos',
      questions: [
        {
          id: 1,
          title: 'Eu tenho acumulado tantas coisas que elas já estão me atrapalhando',
          type: 'likert',
          options: [
            { value: 0, text: '0 nem um pouco' },
            { value: 1, text: '1 Um pouco' },
            { value: 2, text: '2 Moderadamente' },
            { value: 3, text: '3 Muito' },
            { value: 4, text: '4 Extremamente' }
          ]
        },
        {
          id: 2,
          title: 'Eu verifico coisas mais vezes do que é necessário',
          type: 'likert',
          options: [
            { value: 0, text: '0 nem um pouco' },
            { value: 1, text: '1 Um pouco' },
            { value: 2, text: '2 Moderadamente' },
            { value: 3, text: '3 Muito' },
            { value: 4, text: '4 Extremamente' }
          ]
        },
        {
          id: 3,
          title: 'Eu fico chateado se os objetos não estão arrumados corretamente',
          type: 'likert',
          options: [
            { value: 0, text: '0 nem um pouco' },
            { value: 1, text: '1 Um pouco' },
            { value: 2, text: '2 Moderadamente' },
            { value: 3, text: '3 Muito' },
            { value: 4, text: '4 Extremamente' }
          ]
        }
      ],
      scoring: {
        factors: [
          {
            id: 'fator-geral',
            name: 'Fator Geral de Ansiedade',
            questionIds: [1, 2, 3],
            ranges: [
              { min: 0, max: 10, level: 'Baixo', description: 'Este é um nível baixo' },
              { min: 11, max: 12, level: 'Alto', description: 'Este é um nível alto' }
            ]
          },
          {
            id: 'ansiedade-reativa',
            name: 'Ansiedade Reativa',
            questionIds: [1, 2],
            ranges: [
              { min: 0, max: 1, level: 'Baixo', description: 'Este é um nível baixo' },
              { min: 2, max: 3, level: 'Alto', description: 'Este é um nível alto' },
              { min: 4, max: 4, level: 'Muito Alto', description: 'Este é um nível bem alto' }
            ]
          }
        ]
      }
    };

    document.getElementById('btn-sample').addEventListener('click', () => {
      loadTest(sampleData);
    });

    document.getElementById('btn-clear').addEventListener('click', () => {
      if (!confirm('Limpar todos os campos?')) return;
      state.questions = [];
      state.factors = [];
      qList.innerHTML = '';
      fList.innerHTML = '';
      
      // Clear ID field (temporarily enable to clear)
      const idField = document.getElementById('test-id');
      idField.removeAttribute('readonly');
      idField.value = '';
      idField.setAttribute('readonly', 'readonly');
      
      document.getElementById('test-title').value = '';
      document.getElementById('test-desc').value = '';
      document.getElementById('test-tag').value = '';
      document.getElementById('video-url').value = '';
      document.getElementById('article-url').value = '';
      document.getElementById('featured').checked = false;
      document.getElementById('curadoria').checked = false;
      document.getElementById('test-visibility').value = 'public';
      document.getElementById('test-instr').value = '';
      document.getElementById('est-time').value = '';
      updateCounts();
    });

    // Preview Results
    document.getElementById('btn-preview-results').addEventListener('click', () => {
      // Collect current test data
      const testData = collectData();
      
      // Validate basic requirements
      if (!testData.id || !testData.title || testData.questions.length === 0) {
        alert('Por favor, preencha pelo menos ID, Título e adicione questões antes de pré-visualizar.');
        return;
      }
      
      // Get selected scenario
      const scenario = document.getElementById('preview-scenario').value;
      
      // Generate fake answers based on scenario
      const answers = generateFakeAnswers(testData, scenario);
      
      // Store in sessionStorage
      sessionStorage.setItem('previewTestData', JSON.stringify(testData));
      sessionStorage.setItem('previewAnswers', JSON.stringify(answers));
      
      // Open preview in new tab
      window.open('../test.html?preview=true', '_blank');
    });
    
    // Generate fake answers based on scenario
    function generateFakeAnswers(testData, scenario) {
      return testData.questions.map((q, idx) => {
        if (q.type === 'scale') {
          const min = q.min ?? 0;
          const max = q.max ?? 10;
          let value;
          
          if (scenario === 'min') {
            value = min;
          } else if (scenario === 'max') {
            value = max;
          } else if (scenario === 'mid') {
            value = Math.floor((min + max) / 2);
          } else { // random
            value = Math.floor(Math.random() * (max - min + 1)) + min;
          }
          
          return { value, label: `Escala: ${value}` };
          
        } else if (q.type === 'text') {
          return { value: 0, label: 'Resposta de texto simulada' };
          
        } else { // single, likert, yesno - multiple choice with options
          const options = q.options || [];
          if (options.length === 0) {
            return { value: 0, label: 'Sem opção' };
          }
          
          let selectedOption;
          
          if (scenario === 'min') {
            // Select option with minimum value
            selectedOption = options.reduce((min, opt) => 
              (Number(opt.value) < Number(min.value)) ? opt : min
            );
          } else if (scenario === 'max') {
            // Select option with maximum value
            selectedOption = options.reduce((max, opt) => 
              (Number(opt.value) > Number(max.value)) ? opt : max
            );
          } else if (scenario === 'mid') {
            // Select middle option
            const midIndex = Math.floor(options.length / 2);
            selectedOption = options[midIndex];
          } else { // random
            const randomIndex = Math.floor(Math.random() * options.length);
            selectedOption = options[randomIndex];
          }
          
          return { 
            value: Number(selectedOption.value) || 0, 
            label: selectedOption.text 
          };
        }
      });
    }

    // Initialize
    updateCounts();
    loadExistingTestIds();

    // Floating back-to-top
    document.addEventListener('DOMContentLoaded', () => {
      const btnTop = document.getElementById('btn-top');
      if (btnTop) {
        btnTop.addEventListener('click', () => {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      }
    });
  </script>
<button id="btn-top" aria-label="Voltar ao topo" style="position:fixed;bottom:24px;right:24px;width:46px;height:46px;border:none;border-radius:50%;background:#1a4d2e;color:#fff;box-shadow:0 6px 18px rgba(0,0,0,0.2);cursor:pointer;font-size:20px;z-index:500;">↑</button>

</html>

